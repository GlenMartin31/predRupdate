<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to the predRupdate package • predRupdate</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to the predRupdate package">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">predRupdate</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/predRupdate.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/predRupdate_splineIllustration.html">Example of Validating a Model that Includes Spline Terms</a></li>
    <li><a class="dropdown-item" href="../articles/predRupdate_technical.html">Technical Background to predRupdate</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/GlenMartin31/predRupdate/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Introduction to the predRupdate package</h1>
                        <h4 data-toc-skip class="author">Glen P. Martin,
PhD; David Jenkins, PhD; Matthew Sperrin, PhD</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/GlenMartin31/predRupdate/blob/develop/vignettes/predRupdate.Rmd" class="external-link"><code>vignettes/predRupdate.Rmd</code></a></small>
      <div class="d-none name"><code>predRupdate.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="preamble">Preamble<a class="anchor" aria-label="anchor" href="#preamble"></a>
</h2>
<p>The <strong>predRupdate</strong> package includes a set of functions
to aid in the validation of a clinical prediction model (CPM) on a given
dataset, and to apply various model updating and aggregation methods.
This vignette aims to overview, through examples, some common workflows
of using the <strong>predRupdate</strong> package. For a technical
vignette describing the methods underpinning the package, please see
<code><a href="../articles/predRupdate_technical.html">vignette("predRupdate_technical")</a></code>.</p>
<p>The package is focused on the situation where there is an existing
CPM (or multiple CPMs) that has been developed (e.g., a model published
in the literature), and one wishes to apply this model to a new dataset.
We foresee at least three use-cases: (1) where one wishes to validate
the existing CPM on the new data to estimate the model’s predictive
performance, i.e., external validation; (2) where one wishes to apply
model updating methods to the existing CPM to ‘tailor’ it to the new
dataset; and (3) where there are multiple existing CPMs, and one wishes
to apply model aggregation (meta-modelling) methods to pool these models
into a single model for the new dataset. We therefore give three
examples below for each of these use cases.</p>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>The data, called <em>SYNPM</em>, used throughout this vignette are
available within the <strong>predRupdate</strong> package. See “?SYNPM”
for details of these data. In short, the data and models included in
<em>SYNPM</em> are synthetic, but for the purposes of this vignette, we
imagine that one is interested in predicting someone’s risk of mortality
after surgery. Data are available on 20000 people, which records each
individuals age, gender, smoking status, diabetes status, and Creatinine
value at the time of surgery. The data includes the outcomes of “ETime”
representing the time (months) between surgery and either death or
end-of-follow-up (5 months), whichever occurred first. The variable
“Status” indicates if the patient died (1) or was right-censored (0),
and Y denotes a binary variable indicating if the patient died within 1
month.</p>
</div>
<div class="section level2">
<h2 id="example-1-validating-an-existing-prediction-model-on-new-data">Example 1: validating an existing prediction model on new data<a class="anchor" aria-label="anchor" href="#example-1-validating-an-existing-prediction-model-on-new-data"></a>
</h2>
<p>In this first example, we take a situation where a CPM has previously
been developed (in another dataset) to predict the risk of mortality
within 1 month of surgery, and we wish to validate this model in our
dataset to test the predictive performance (e.g., an external validation
study).</p>
<p>The existing model was a logistic regression model, with the
following predictor variables and coefficients (log-odds ratios):</p>
<table class="table">
<caption>Table of coefficients for the existing logistic regression
prediction model</caption>
<thead><tr class="header">
<th align="left"></th>
<th align="right">Coefficient</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Intercept</td>
<td align="right">-3.995</td>
</tr>
<tr class="even">
<td align="left">Age</td>
<td align="right">0.012</td>
</tr>
<tr class="odd">
<td align="left">SexM</td>
<td align="right">0.267</td>
</tr>
<tr class="even">
<td align="left">Smoking_Status</td>
<td align="right">0.751</td>
</tr>
<tr class="odd">
<td align="left">Diabetes</td>
<td align="right">0.523</td>
</tr>
<tr class="even">
<td align="left">Creatinine</td>
<td align="right">0.578</td>
</tr>
</tbody>
</table>
<p>The first step in using <strong>predRupdate</strong> to validate this
model is to input the model information. We start by creating a
data.frame of the model coefficients, with the columns being the
predictor variable names. This information is then passed into the
<code><a href="../reference/pred_input_info.html">pred_input_info()</a></code> function to input the information about
the existing model. See <code><a href="../reference/pred_input_info.html">pred_input_info()</a></code> for details.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a data.frame of the model coefficients, with columns being variables</span></span>
<span><span class="va">coefs_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"Intercept"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">3.995</span>, <span class="co">#the intercept needs to be named exactly as given here</span></span>
<span>                          <span class="st">"Age"</span> <span class="op">=</span> <span class="fl">0.012</span>,</span>
<span>                          <span class="st">"SexM"</span> <span class="op">=</span> <span class="fl">0.267</span>, </span>
<span>                          <span class="st">"Smoking_Status"</span> <span class="op">=</span> <span class="fl">0.751</span>,</span>
<span>                          <span class="st">"Diabetes"</span> <span class="op">=</span> <span class="fl">0.523</span>,</span>
<span>                          <span class="st">"Creatinine"</span> <span class="op">=</span> <span class="fl">0.578</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#pass this into pred_input_info()</span></span>
<span><span class="va">Existing_Logistic_Model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_input_info.html">pred_input_info</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="st">"logistic"</span>,</span>
<span>                                           model_info <span class="op">=</span> <span class="va">coefs_table</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">Existing_Logistic_Model</span><span class="op">)</span></span>
<span><span class="co">#&gt; Information about 1 existing model(s) of type 'logistic' </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model Coefficients </span></span>
<span><span class="co">#&gt; ================================= </span></span>
<span><span class="co">#&gt;   Intercept   Age  SexM Smoking_Status Diabetes Creatinine</span></span>
<span><span class="co">#&gt; 1    -3.995 0.012 0.267          0.751    0.523      0.578</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model Functional Form </span></span>
<span><span class="co">#&gt; ================================= </span></span>
<span><span class="co">#&gt; Age + SexM + Smoking_Status + Diabetes + Creatinine</span></span></code></pre></div>
<p>Next we wish to apply this model to our dataset to calculate the
predicted risks for each individual, and then compare these predictions
with the observed outcomes to calculate predictive performance. This can
all be achieved with the <code><a href="../reference/pred_validate.html">pred_validate()</a></code> function, as
follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">validation_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_validate.html">pred_validate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Existing_Logistic_Model</span>,</span>
<span>                                    new_data <span class="op">=</span> <span class="va">SYNPM</span><span class="op">$</span><span class="va">ValidationData</span>,</span>
<span>                                    binary_outcome <span class="op">=</span> <span class="st">"Y"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">validation_results</span><span class="op">)</span> <span class="co">#use summary() to obtain a tidy output summary of the model performance</span></span>
<span><span class="co">#&gt; Calibration Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt;                         Estimate Lower 95% Confidence Interval</span></span>
<span><span class="co">#&gt; Observed:Expected Ratio   1.8583                        1.7959</span></span>
<span><span class="co">#&gt; Calibration Intercept     0.7076                        0.6673</span></span>
<span><span class="co">#&gt; Calibration Slope         0.6496                        0.5588</span></span>
<span><span class="co">#&gt;                         Upper 95% Confidence Interval</span></span>
<span><span class="co">#&gt; Observed:Expected Ratio                        1.9228</span></span>
<span><span class="co">#&gt; Calibration Intercept                          0.7479</span></span>
<span><span class="co">#&gt; Calibration Slope                              0.7403</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Also examine the calibration plot, if produced. </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Discrimination Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt;     Estimate Lower 95% Confidence Interval Upper 95% Confidence Interval</span></span>
<span><span class="co">#&gt; AUC   0.5816                        0.5703                        0.5928</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Overall Performance Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt; Cox-Snell R-squared: -0.0446</span></span>
<span><span class="co">#&gt; Nagelkerke R-squared: -0.0801</span></span>
<span><span class="co">#&gt; Brier Score (CI): 0.1246 (0.1216, 0.1276)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Also examine the distribution plot of predicted risks.</span></span></code></pre></div>
<p>This produces an output of the various metrics of model calibration
(e.g., calibration intercept and slope), discrimination (e.g., area
under the ROC curve) and overall performance (e.g., R-squared). We can
see that this model has poor calibration (calibration intercept and
slope significantly different from 0 and 1, respectively), and poor
discrimination. We can also obtain the flexible calibration plot, as</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">validation_results</span><span class="op">)</span></span></code></pre></div>
<p><img src="predRupdate_files/figure-html/unnamed-chunk-5-1.png" width="960"></p>
<p>The left-panel shows a box-plot and violin-plot of the probability
distributions, stratified by outcome, and the right-panel shows the
flexible calibration plot. The package returns these plots as ggplot2
objects, so further modification of the plots can be made using ggplot2
statements. For example, one can change the theme of the plot as:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">validation_results</span><span class="op">$</span><span class="va">flex_calibrationplot</span> <span class="op">+</span> </span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu">ggplot2</span><span class="fu">:::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">x</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">x</span>, which will replace the existing scale.</span></span>
<span><span class="co">#&gt; Scale for <span style="color: #00BB00;">y</span> is already present.</span></span>
<span><span class="co">#&gt; Adding another scale for <span style="color: #00BB00;">y</span>, which will replace the existing scale.</span></span></code></pre></div>
<p><img src="predRupdate_files/figure-html/unnamed-chunk-6-1.png" width="576"></p>
<p>One may wish to update this model to the new dataset - see Example 2
below.</p>
<p>By default, 95% CIs are calculated for each performance metric. This
can be changed by specifying level, as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">validation_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_validate.html">pred_validate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Existing_Logistic_Model</span>,</span>
<span>                                    new_data <span class="op">=</span> <span class="va">SYNPM</span><span class="op">$</span><span class="va">ValidationData</span>,</span>
<span>                                    binary_outcome <span class="op">=</span> <span class="st">"Y"</span>,</span>
<span>                                    level <span class="op">=</span> <span class="fl">0.90</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">validation_results</span><span class="op">)</span> <span class="co">#use summary() to obtain a tidy output summary of the model performance</span></span>
<span><span class="co">#&gt; Calibration Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt;                         Estimate Lower 90% Confidence Interval</span></span>
<span><span class="co">#&gt; Observed:Expected Ratio   1.8583                        1.8058</span></span>
<span><span class="co">#&gt; Calibration Intercept     0.7076                        0.6738</span></span>
<span><span class="co">#&gt; Calibration Slope         0.6496                        0.5734</span></span>
<span><span class="co">#&gt;                         Upper 90% Confidence Interval</span></span>
<span><span class="co">#&gt; Observed:Expected Ratio                        1.9123</span></span>
<span><span class="co">#&gt; Calibration Intercept                          0.7414</span></span>
<span><span class="co">#&gt; Calibration Slope                              0.7257</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Also examine the calibration plot, if produced. </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Discrimination Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt;     Estimate Lower 90% Confidence Interval Upper 90% Confidence Interval</span></span>
<span><span class="co">#&gt; AUC   0.5816                        0.5722                         0.591</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Overall Performance Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt; Cox-Snell R-squared: -0.0446</span></span>
<span><span class="co">#&gt; Nagelkerke R-squared: -0.0801</span></span>
<span><span class="co">#&gt; Brier Score (CI): 0.1246 (0.1221, 0.1272)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Also examine the distribution plot of predicted risks.</span></span></code></pre></div>
<div class="section level3">
<h3 id="survival-analysis-model">Survival analysis model<a class="anchor" aria-label="anchor" href="#survival-analysis-model"></a>
</h3>
<p>The above example considered the validation of an existing CPM that
was based on logistic regression. <strong>predRupdate</strong> also
contains functionality to validate CPMs that are based on time-to-event
(survival) models (e.g. a Cox proportional hazards model). In such a
case, the baseline cumulative hazard of the model should also be
specified, along with the regression coefficients.</p>
<p>In many cases, the baseline cumulative hazard of an existing CPM will
not be reported in “full”, but rather estimates of the baseline
cumulative hazard will be given at set follow-up times. To use
<strong>predRupdate</strong>, users should specify the baseline
cumulative hazard at the times at which one wishes to make predictions
(or validate/update the model).</p>
<p>For example, suppose an existing CPM was developed using Cox
proportional hazards to predict time-to-death after surgery, with the
following predictor parameters (log hazard ratios):</p>
<table class="table">
<caption>Table of coefficients for the existing time-to-event regression
prediction model</caption>
<thead><tr class="header">
<th align="left"></th>
<th align="right">Coefficient</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Age</td>
<td align="right">0.007</td>
</tr>
<tr class="even">
<td align="left">SexM</td>
<td align="right">0.225</td>
</tr>
<tr class="odd">
<td align="left">Smoking_Status</td>
<td align="right">0.685</td>
</tr>
<tr class="even">
<td align="left">Diabetes</td>
<td align="right">0.425</td>
</tr>
<tr class="odd">
<td align="left">Creatinine</td>
<td align="right">0.587</td>
</tr>
</tbody>
</table>
<p>and with the following baseline cumulative hazard reported at
discrete times of months 1-5 post surgery:</p>
<table class="table">
<caption>Table of baseline cumulative hazard</caption>
<thead><tr class="header">
<th align="right">time</th>
<th align="right">hazard</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">1</td>
<td align="right">0.0230191</td>
</tr>
<tr class="even">
<td align="right">2</td>
<td align="right">0.0475351</td>
</tr>
<tr class="odd">
<td align="right">3</td>
<td align="right">0.0720775</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">0.0969976</td>
</tr>
<tr class="odd">
<td align="right">5</td>
<td align="right">0.1209202</td>
</tr>
</tbody>
</table>
<p>We can then use the <code><a href="../reference/pred_validate.html">pred_validate()</a></code> function to validate
this model at 1, 2, 3, 4 or 5 months follow-up in the new dataset. To
achieve this, one follows a similar syntax to above for the logistic
model. The main difference is that one needs to specify a time during
follow-up that we’d like to validate the model against - this time must
also be available in the baseline cumulative hazard provided.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a data.frame of the model coefficients, with columns being variables</span></span>
<span><span class="va">coefs_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"Age"</span> <span class="op">=</span> <span class="fl">0.007</span>,</span>
<span>                          <span class="st">"SexM"</span> <span class="op">=</span> <span class="fl">0.225</span>,</span>
<span>                          <span class="st">"Smoking_Status"</span> <span class="op">=</span> <span class="fl">0.685</span>,</span>
<span>                          <span class="st">"Diabetes"</span> <span class="op">=</span> <span class="fl">0.425</span>,</span>
<span>                          <span class="st">"Creatinine"</span> <span class="op">=</span> <span class="fl">0.587</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#pass this into pred_input_info()</span></span>
<span><span class="va">Existing_TTE_Model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_input_info.html">pred_input_info</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>                                      model_info <span class="op">=</span> <span class="va">coefs_table</span>,</span>
<span>                                      cum_hazard <span class="op">=</span> <span class="va">BH_table</span><span class="op">)</span> <span class="co">#where BH_table is the baseline hazard above</span></span>
<span></span>
<span><span class="co">#now validate against the time-to-event outcomes in the new dataset:</span></span>
<span><span class="va">validation_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_validate.html">pred_validate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Existing_TTE_Model</span>,</span>
<span>                                    new_data <span class="op">=</span> <span class="va">SYNPM</span><span class="op">$</span><span class="va">ValidationData</span>,</span>
<span>                                    survival_time <span class="op">=</span> <span class="st">"ETime"</span>,</span>
<span>                                    event_indicator <span class="op">=</span> <span class="st">"Status"</span>,</span>
<span>                                    time_horizon <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">validation_results</span><span class="op">)</span></span>
<span><span class="co">#&gt; Calibration Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt;                         Estimate Lower 95% Confidence Interval</span></span>
<span><span class="co">#&gt; Observed:Expected Ratio   1.2211                        1.2002</span></span>
<span><span class="co">#&gt; Calibration Slope         0.7129                        0.6580</span></span>
<span><span class="co">#&gt;                         Upper 95% Confidence Interval</span></span>
<span><span class="co">#&gt; Observed:Expected Ratio                        1.2423</span></span>
<span><span class="co">#&gt; Calibration Slope                              0.7679</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Also examine the calibration plot, if produced. </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Discrimination Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt;           Estimate Lower 95% Confidence Interval Upper 95% Confidence Interval</span></span>
<span><span class="co">#&gt; Harrell C   0.5789                        0.5726                        0.5852</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Also examine the distribution plot of predicted risks.</span></span></code></pre></div>
<p>Here, we see that the existing model under-predicts the mean risk at
5-months (observed:Expected Ratio greater than 1), and there is evidence
of over-fitting. The model also has poor discrimination (Harrell C). We
can also see this from the plot of the distribution of predicted risks,
and the calibration plot, as follows:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">validation_results</span><span class="op">)</span></span></code></pre></div>
<p><img src="predRupdate_files/figure-html/unnamed-chunk-11-1.png" width="960"></p>
<div class="section level4">
<h4 id="specifying-the-baseline-cumulative-hazard">Specifying the baseline cumulative hazard<a class="anchor" aria-label="anchor" href="#specifying-the-baseline-cumulative-hazard"></a>
</h4>
<p>When validating an existing time-to-event model, the baseline
cumulative hazard of the existing CPM should be reported (e.g., from the
original model publication). In some cases, this might be reported at
discrete follow-up times (like in the above example). Alternatively, the
entire baseline cumulative hazard curve may be presented as a plot, or
indeed a parametric form of the baseline cumulative hazard may be
provided. In those situations, one should extract (from the plot) or
calculate (from the parametric form) the baseline cumulative hazard at
multiple follow-up times of interest (i.e., the follow-up times at which
one wishes to validate the model against).</p>
<p>However, in some cases, the baseline cumulative hazard of the
existing time-to-event CPM may not be reported. In such a situation, one
can still use <strong>predRupdate</strong> to validate such a model.
However, only a limited number of metrics will be produced (i.e., only
those metrics that require the linear predictor, not absolute risk
predictions at a given follow-up time). Specifically, the
observed:expected ratio and the calibration plot will not be produced if
the baseline cumulative hazard is not provided.</p>
<div class="section level5">
<h5 id="a-note-on-basehaz-in-r">A note on basehaz() in R<a class="anchor" aria-label="anchor" href="#a-note-on-basehaz-in-r"></a>
</h5>
<p>If one has fit a Cox Proportional Hazards model in R (using coxph()
from the survival package), and wishes to use
<strong>predRupdate</strong> to internally validate this model, then the
cumulative baseline hazard of the model must be estimated, and this can
be done using the basehaz() function of the survival package. In this
situation, care must be taken with regards to centering the data. By
default, coxph() internally scales and centers the data that the model
is being fit on (see ?survival::coxph() for details). As such, users
should either pass newdata to basehaz() with values of each model
covariate set to give the baseline cumulative hazard (e.g., 0 for
continuous covariates or reference category for categorical/factor
covariates), or make use of the ‘centrered=FALSE’ option in basehaz().
Not doing this means that basehaz() will return the cumulative baseline
hazard for centered and scaled covariate values (see
?survival::basehaz() for details; specifically, the ‘centered=TRUE’
argument of that function). If one then passes the resulting baseline
hazard into <strong>predRupdate</strong> package functions, care must be
taken to also scale and centre the new_data that are passed to
<strong>predRupdate</strong> functions. Our package functions make no
attempt at checking this consistency, and users are advised to ensure
that the baseline cumulative hazard is consistent with the format of the
new data that is being provided to validate the model.</p>
<p>The below example code illustrates these points:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">SYNPM</span><span class="op">$</span><span class="va">ValidationData</span></span>
<span></span>
<span><span class="va">cox_mod</span> <span class="op">&lt;-</span> <span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">ETime</span>, <span class="va">Status</span><span class="op">)</span> <span class="op">~</span> <span class="va">Age</span> <span class="op">+</span> <span class="va">Creatinine</span>, </span>
<span>                           data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span><span class="va">coefs_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"Age"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">cox_mod</span><span class="op">)</span><span class="op">[</span><span class="st">"Age"</span><span class="op">]</span>,</span>
<span>                          <span class="st">"Creatinine"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">cox_mod</span><span class="op">)</span><span class="op">[</span><span class="st">"Creatinine"</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#example of using basehaz() for uncentered/values:</span></span>
<span><span class="va">base_haz_zero</span> <span class="op">&lt;-</span> <span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/basehaz.html" class="external-link">basehaz</a></span><span class="op">(</span><span class="va">cox_mod</span>, </span>
<span>                                   newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"Age"</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                                        <span class="st">"Creatinine"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#or use centered=FALSE in survival::basehaz()</span></span>
<span><span class="co">#base_haz_zero &lt;- survival::basehaz(cox_mod, centered = FALSE)</span></span>
<span></span>
<span><span class="va">Existing_TTE_Model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_input_info.html">pred_input_info</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>                                      model_info <span class="op">=</span> <span class="va">coefs_table</span>,</span>
<span>                                      cum_hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"time"</span> <span class="op">=</span> <span class="va">base_haz_zero</span><span class="op">$</span><span class="va">time</span>,</span>
<span>                                                              <span class="st">"hazard"</span> <span class="op">=</span> <span class="va">base_haz_zero</span><span class="op">$</span><span class="va">hazard</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/pred_validate.html">pred_validate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Existing_TTE_Model</span>,</span>
<span>              new_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"Age"</span> <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">Age</span>,</span>
<span>                                    <span class="st">"Creatinine"</span> <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">Creatinine</span>,</span>
<span>                                    <span class="st">"ETime"</span> <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">ETime</span>,</span>
<span>                                    <span class="st">"Status"</span> <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">Status</span><span class="op">)</span>,</span>
<span>              survival_time <span class="op">=</span> <span class="st">"ETime"</span>,</span>
<span>              event_indicator <span class="op">=</span> <span class="st">"Status"</span>,</span>
<span>              time_horizon <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">#Alternatively, the below code shows how to handle the scaled/centred baseline </span></span>
<span><span class="co"># hazard, such that we need to also scale/centre the new_data:</span></span>
<span><span class="va">base_haz_centred</span> <span class="op">&lt;-</span> <span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/basehaz.html" class="external-link">basehaz</a></span><span class="op">(</span><span class="va">cox_mod</span><span class="op">)</span></span>
<span><span class="va">Existing_TTE_Model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_input_info.html">pred_input_info</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="st">"survival"</span>,</span>
<span>                                      model_info <span class="op">=</span> <span class="va">coefs_table</span>,</span>
<span>                                      cum_hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"time"</span> <span class="op">=</span> <span class="va">base_haz_centred</span><span class="op">$</span><span class="va">time</span>,</span>
<span>                                                              <span class="st">"hazard"</span> <span class="op">=</span> <span class="va">base_haz_centred</span><span class="op">$</span><span class="va">hazard</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/pred_validate.html">pred_validate</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Existing_TTE_Model</span>,</span>
<span>              new_data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"Age"</span> <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">Age</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Age</span><span class="op">)</span>,</span>
<span>                                    <span class="st">"Creatinine"</span> <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">Creatinine</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Creatinine</span><span class="op">)</span>,</span>
<span>                                    <span class="st">"ETime"</span> <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">ETime</span>,</span>
<span>                                    <span class="st">"Status"</span> <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">Status</span><span class="op">)</span>,</span>
<span>              survival_time <span class="op">=</span> <span class="st">"ETime"</span>,</span>
<span>              event_indicator <span class="op">=</span> <span class="st">"Status"</span>,</span>
<span>              time_horizon <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#failing to mean-center new_data passed into pred_validate() would give erroneous results.</span></span></code></pre></div>
</div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="example-2-model-updating-on-new-data">Example 2: model updating on new data<a class="anchor" aria-label="anchor" href="#example-2-model-updating-on-new-data"></a>
</h2>
<p>In the validation of an existing logistic regression model in Example
1 above, we found that the existing model was miscalibrated in the new
data. One strategy to handle this is to apply a range of model updating
methods; see <code><a href="../articles/predRupdate_technical.html">vignette("predRupdate_technical")</a></code> for a
technical discussion of these methods.</p>
<p>To illustrate how to achieve this with <strong>predRupdate</strong>,
we here choose to apply model re-calibration to the existing logistic
regression model shown in Example 1 above. Within
<strong>predRupdate</strong>, we use <code><a href="../reference/pred_update.html">pred_update()</a></code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a data.frame of the model coefficients, with columns being variables</span></span>
<span><span class="va">coefs_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"Intercept"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">3.995</span>, </span>
<span>                          <span class="st">"Age"</span> <span class="op">=</span> <span class="fl">0.012</span>,</span>
<span>                          <span class="st">"SexM"</span> <span class="op">=</span> <span class="fl">0.267</span>, </span>
<span>                          <span class="st">"Smoking_Status"</span> <span class="op">=</span> <span class="fl">0.751</span>,</span>
<span>                          <span class="st">"Diabetes"</span> <span class="op">=</span> <span class="fl">0.523</span>,</span>
<span>                          <span class="st">"Creatinine"</span> <span class="op">=</span> <span class="fl">0.578</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#pass this into pred_input_info()</span></span>
<span><span class="va">Existing_Logistic_Model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_input_info.html">pred_input_info</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="st">"logistic"</span>,</span>
<span>                                           model_info <span class="op">=</span> <span class="va">coefs_table</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#apply the pred_update function to update the model to the new dataset:</span></span>
<span><span class="va">Updated_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_update.html">pred_update</a></span><span class="op">(</span><span class="va">Existing_Logistic_Model</span>,</span>
<span>                             update_type <span class="op">=</span> <span class="st">"recalibration"</span>,</span>
<span>                             new_data <span class="op">=</span> <span class="va">SYNPM</span><span class="op">$</span><span class="va">ValidationData</span>,</span>
<span>                             binary_outcome <span class="op">=</span> <span class="st">"Y"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">Updated_model</span><span class="op">)</span></span>
<span><span class="co">#&gt; Original model was updated with type recalibration</span></span>
<span><span class="co">#&gt; The model updating results are as follows: </span></span>
<span><span class="co">#&gt;               Estimate Std. Error</span></span>
<span><span class="co">#&gt; (Intercept) -0.1579827 0.11713282</span></span>
<span><span class="co">#&gt; Slope        0.6495556 0.04629572</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Updated Model Coefficients </span></span>
<span><span class="co">#&gt; ================================= </span></span>
<span><span class="co">#&gt;   Intercept         Age      SexM Smoking_Status  Diabetes Creatinine</span></span>
<span><span class="co">#&gt; 1 -2.752957 0.007794668 0.1734314      0.4878163 0.3397176  0.3754432</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model Functional Form </span></span>
<span><span class="co">#&gt; ================================= </span></span>
<span><span class="co">#&gt; Age + SexM + Smoking_Status + Diabetes + Creatinine</span></span></code></pre></div>
<p>One could then validate this updated model using
<code><a href="../reference/pred_validate.html">pred_validate()</a></code>, but given we have updated the model in the
new data, then in-practice any such performance estimates would need to
be adjusted for in-sample optimism (e.g., using cross-validation or
bootstrap internal validation):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/pred_validate.html">pred_validate</a></span><span class="op">(</span><span class="va">Updated_model</span>, </span>
<span>                      new_data <span class="op">=</span> <span class="va">SYNPM</span><span class="op">$</span><span class="va">ValidationData</span>, </span>
<span>                      binary_outcome <span class="op">=</span> <span class="st">"Y"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Calibration Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt;                         Estimate Lower 95% Confidence Interval</span></span>
<span><span class="co">#&gt; Observed:Expected Ratio        1                        0.9664</span></span>
<span><span class="co">#&gt; Calibration Intercept          0                       -0.0400</span></span>
<span><span class="co">#&gt; Calibration Slope              1                        0.8603</span></span>
<span><span class="co">#&gt;                         Upper 95% Confidence Interval</span></span>
<span><span class="co">#&gt; Observed:Expected Ratio                        1.0347</span></span>
<span><span class="co">#&gt; Calibration Intercept                          0.0400</span></span>
<span><span class="co">#&gt; Calibration Slope                              1.1397</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Also examine the calibration plot, if produced. </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Discrimination Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt;     Estimate Lower 95% Confidence Interval Upper 95% Confidence Interval</span></span>
<span><span class="co">#&gt; AUC   0.5816                        0.5703                        0.5928</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Overall Performance Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt; Cox-Snell R-squared: 0.0095</span></span>
<span><span class="co">#&gt; Nagelkerke R-squared: 0.0171</span></span>
<span><span class="co">#&gt; Brier Score (CI): 0.1203 (0.1169, 0.1237)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Also examine the distribution plot of predicted risks.</span></span></code></pre></div>
<p>Similar functionality is available for time-to-event models, using a
similar syntax.</p>
</div>
<div class="section level2">
<h2 id="example-3-model-aggregation-on-new-data">Example 3: model aggregation on new data<a class="anchor" aria-label="anchor" href="#example-3-model-aggregation-on-new-data"></a>
</h2>
<p>Sometimes, there might be multiple existing CPMs available for the
same prediction task (e.g., existing models developed across different
countries, each aiming to predict the same outcome). Here, model
aggregation methods can be used to pool these existing CPMs into a
single model in the new data; see
<code><a href="../articles/predRupdate_technical.html">vignette("predRupdate_technical")</a></code> for a technical
discussion of these methods.</p>
<p>To implement these methods within <strong>predRupdate</strong>, we
first need to input the information about the multiple existing models
into <code><a href="../reference/pred_input_info.html">pred_input_info()</a></code>. Each row of the model_info
parameter should be the coefficients of an existing CPM; any parameter
that is not included in a given CPM should have value NA, as shown
below:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coefs_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Intercept"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">3.995</span>,</span>
<span>                                  <span class="st">"Age"</span> <span class="op">=</span> <span class="fl">0.012</span>,</span>
<span>                                  <span class="st">"SexM"</span> <span class="op">=</span> <span class="fl">0.267</span>,</span>
<span>                                  <span class="st">"Smoking_Status"</span> <span class="op">=</span> <span class="fl">0.751</span>,</span>
<span>                                  <span class="st">"Diabetes"</span> <span class="op">=</span> <span class="fl">0.523</span>,</span>
<span>                                  <span class="st">"Creatinine"</span> <span class="op">=</span> <span class="fl">0.578</span><span class="op">)</span>,</span>
<span>                                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Intercept"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">2.282</span>,</span>
<span>                                  <span class="st">"Age"</span> <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                                  <span class="st">"SexM"</span> <span class="op">=</span> <span class="fl">0.223</span>,</span>
<span>                                  <span class="st">"Smoking_Status"</span> <span class="op">=</span> <span class="fl">0.528</span>,</span>
<span>                                  <span class="st">"Diabetes"</span> <span class="op">=</span> <span class="fl">0.200</span>,</span>
<span>                                  <span class="st">"Creatinine"</span> <span class="op">=</span> <span class="fl">0.434</span><span class="op">)</span>,</span>
<span>                                <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Intercept"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">3.013</span>,</span>
<span>                                  <span class="st">"Age"</span> <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                                  <span class="st">"SexM"</span> <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                                  <span class="st">"Smoking_Status"</span> <span class="op">=</span> <span class="fl">0.565</span>,</span>
<span>                                  <span class="st">"Diabetes"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">0.122</span>,</span>
<span>                                  <span class="st">"Creatinine"</span> <span class="op">=</span> <span class="fl">0.731</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">multiple_mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_input_info.html">pred_input_info</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="st">"logistic"</span>,</span>
<span>                                 model_info <span class="op">=</span> <span class="va">coefs_table</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">multiple_mods</span><span class="op">)</span></span>
<span><span class="co">#&gt; Information about 3 existing model(s) of type 'logistic' </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model Coefficients </span></span>
<span><span class="co">#&gt; ================================= </span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt;   Intercept   Age  SexM Smoking_Status Diabetes Creatinine</span></span>
<span><span class="co">#&gt; 1    -3.995 0.012 0.267          0.751    0.523      0.578</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt;   Intercept  SexM Smoking_Status Diabetes Creatinine</span></span>
<span><span class="co">#&gt; 2    -2.282 0.223          0.528      0.2      0.434</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt;   Intercept Smoking_Status Diabetes Creatinine</span></span>
<span><span class="co">#&gt; 3    -3.013          0.565   -0.122      0.731</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model Functional Form </span></span>
<span><span class="co">#&gt; ================================= </span></span>
<span><span class="co">#&gt; Model 1: Age + SexM + Smoking_Status + Diabetes + Creatinine</span></span>
<span><span class="co">#&gt; Model 2: SexM + Smoking_Status + Diabetes + Creatinine</span></span>
<span><span class="co">#&gt; Model 3: Smoking_Status + Diabetes + Creatinine</span></span></code></pre></div>
<p>We can then use <code><a href="../reference/pred_stacked_regression.html">pred_stacked_regression()</a></code> to apply
stacked regression to aggregate these models into a single model for the
new dataset:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">SR</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_stacked_regression.html">pred_stacked_regression</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">multiple_mods</span>,</span>
<span>                              new_data <span class="op">=</span> <span class="va">SYNPM</span><span class="op">$</span><span class="va">ValidationData</span>,</span>
<span>                              binary_outcome <span class="op">=</span> <span class="st">"Y"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">SR</span><span class="op">)</span></span>
<span><span class="co">#&gt; Existing models aggregated using stacked regression</span></span>
<span><span class="co">#&gt; The model stacked regression weights are as follows: </span></span>
<span><span class="co">#&gt; (Intercept)         LP1         LP2         LP3 </span></span>
<span><span class="co">#&gt;  0.02072515  0.48150208  0.12920227  0.16559034 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Updated Model Coefficients </span></span>
<span><span class="co">#&gt; ================================= </span></span>
<span><span class="co">#&gt;   Intercept         Age      SexM Smoking_Status Diabetes Creatinine</span></span>
<span><span class="co">#&gt; 1 -2.696639 0.005778025 0.1573732      0.5233854 0.257464  0.4554285</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model Functional Form </span></span>
<span><span class="co">#&gt; ================================= </span></span>
<span><span class="co">#&gt; Age + SexM + Smoking_Status + Diabetes + Creatinine</span></span></code></pre></div>
<p>One could then validate this updated model using
<code><a href="../reference/pred_validate.html">pred_validate()</a></code>, but given we have updated the model in the
new data, then in-practice any such performance estimates would need to
be adjusted for in-sample optimism (e.g., using cross-validation or
bootstrap internal validation):</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="fu"><a href="../reference/pred_validate.html">pred_validate</a></span><span class="op">(</span><span class="va">SR</span>, </span>
<span>              new_data <span class="op">=</span> <span class="va">SYNPM</span><span class="op">$</span><span class="va">ValidationData</span>, </span>
<span>              binary_outcome <span class="op">=</span> <span class="st">"Y"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Calibration Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt;                         Estimate Lower 95% Confidence Interval</span></span>
<span><span class="co">#&gt; Observed:Expected Ratio        1                        0.9664</span></span>
<span><span class="co">#&gt; Calibration Intercept          0                       -0.0400</span></span>
<span><span class="co">#&gt; Calibration Slope              1                        0.8623</span></span>
<span><span class="co">#&gt;                         Upper 95% Confidence Interval</span></span>
<span><span class="co">#&gt; Observed:Expected Ratio                        1.0347</span></span>
<span><span class="co">#&gt; Calibration Intercept                          0.0400</span></span>
<span><span class="co">#&gt; Calibration Slope                              1.1377</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Also examine the calibration plot, if produced. </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Discrimination Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt;     Estimate Lower 95% Confidence Interval Upper 95% Confidence Interval</span></span>
<span><span class="co">#&gt; AUC    0.583                        0.5717                        0.5943</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Overall Performance Measures </span></span>
<span><span class="co">#&gt; --------------------------------- </span></span>
<span><span class="co">#&gt; Cox-Snell R-squared: 0.0098</span></span>
<span><span class="co">#&gt; Nagelkerke R-squared: 0.0175</span></span>
<span><span class="co">#&gt; Brier Score (CI): 0.1203 (0.1169, 0.1237)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Also examine the distribution plot of predicted risks.</span></span></code></pre></div>
<p>Similar functionality is available for time-to-event models.</p>
</div>
<div class="section level2">
<h2 id="a-note-on-structure-of-new_data">A note on structure of new_data<a class="anchor" aria-label="anchor" href="#a-note-on-structure-of-new_data"></a>
</h2>
<p>As shown above, the workflow within <strong>predRupdate</strong> is
broadly in two main stages: (i) input information about the existing
CPM(s) using <code><a href="../reference/pred_input_info.html">pred_input_info()</a></code>, and then (ii) make
predictions, perform validation, perform model updating or conduct model
aggregation methods using <code><a href="../reference/pred_predict.html">pred_predict()</a></code>
<code><a href="../reference/pred_validate.html">pred_validate()</a></code>, <code><a href="../reference/pred_update.html">pred_update()</a></code> or
<code><a href="../reference/pred_stacked_regression.html">pred_stacked_regression()</a></code>, respectively. Stage (i) requires
specification of the ‘model_info’ parameter (which contains the
information of the model parameters), and stage (ii) requires
specification of the ‘new_data’ on which one wishes to apply the
existing CPM(s). It is a requirement that there is consistency between
the parameter/coefficient names given in the ‘model_info’ parameter of
<code><a href="../reference/pred_input_info.html">pred_input_info()</a></code> and the names of variables in “new_data”
of <code><a href="../reference/pred_predict.html">pred_predict()</a></code> <code><a href="../reference/pred_validate.html">pred_validate()</a></code>,
<code><a href="../reference/pred_update.html">pred_update()</a></code> or <code><a href="../reference/pred_stacked_regression.html">pred_stacked_regression()</a></code>.
Specifically, each coefficient named in ‘model_info’ should also be a
column of ‘new_data’.</p>
<p>For example, the following results in an error, because the smoking
variable passed through model_info in <code><a href="../reference/pred_input_info.html">pred_input_info()</a></code>
does not match a name of the smoking variable in ‘new_data’ passed to
<code><a href="../reference/pred_predict.html">pred_predict()</a></code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a data.frame of the model coefficients, with columns being variables</span></span>
<span><span class="va">coefs_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"Intercept"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">3.995</span>, </span>
<span>                          <span class="st">"Smoking"</span> <span class="op">=</span> <span class="fl">0.751</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#pass this into pred_input_info()</span></span>
<span><span class="va">Existing_Logistic_Model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_input_info.html">pred_input_info</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="st">"logistic"</span>,</span>
<span>                                           model_info <span class="op">=</span> <span class="va">coefs_table</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="../reference/pred_predict.html">pred_predict</a></span><span class="op">(</span><span class="va">Existing_Logistic_Model</span>, </span>
<span>                 new_data <span class="op">=</span> <span class="va">SYNPM</span><span class="op">$</span><span class="va">ValidationData</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in map_newdata.predinfo_logistic(x = x, new_data = new_data, binary_outcome = binary_outcome,  : </span></span>
<span><span class="co">#&gt;   new_data does not contain some of the predictor variables for the model(s) specified within the pminfo object</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">SYNPM</span><span class="op">$</span><span class="va">ValidationData</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Age"            "SexM"           "Smoking_Status" "Diabetes"      </span></span>
<span><span class="co">#&gt; [5] "Creatinine"     "ETime"          "Status"         "Y"</span></span></code></pre></div>
<p>Moreover, particular care should be given to any categorical/factor
variables within new_data. For example, suppose we have the following
new_data:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"Sex"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"M"</span>, <span class="st">"F"</span>, <span class="st">"M"</span>, <span class="st">"M"</span>, <span class="st">"F"</span>, <span class="st">"F"</span>, <span class="st">"M"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     <span class="st">"Smoking_Status"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Here, Sex is recorded as a factor variable with levels “M” and “F”.
Before working with functions in <strong>predRupdate</strong>, one must
first convert any factor variables to indicator/dummy variables. We
provide <code><a href="../reference/dummy_vars.html">dummy_vars()</a></code> within <strong>predRupdate</strong> to
assist with this. For example:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coefs_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="st">"Intercept"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">3.4</span>,</span>
<span>                          <span class="st">"Sex_M"</span> <span class="op">=</span> <span class="fl">0.306</span>,</span>
<span>                          <span class="st">"Smoking_Status"</span> <span class="op">=</span> <span class="fl">0.628</span><span class="op">)</span></span>
<span><span class="va">existing_Logistic_Model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pred_input_info.html">pred_input_info</a></span><span class="op">(</span>model_type <span class="op">=</span> <span class="st">"logistic"</span>,</span>
<span>                                           model_info <span class="op">=</span> <span class="va">coefs_table</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#if we try to use functions within predRupdate using new_df it will give an error as Sex is a factor variable:</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="../reference/pred_predict.html">pred_predict</a></span><span class="op">(</span><span class="va">existing_Logistic_Model</span>, </span>
<span>                 new_data <span class="op">=</span> <span class="va">new_df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in map_newdata.predinfo_logistic(x = x, new_data = new_data, binary_outcome = binary_outcome,  : </span></span>
<span><span class="co">#&gt;   'new_data' contains factor variables - convert to dummy/indicator variables first </span></span>
<span><span class="co">#&gt;  dummy_vars() can help with this</span></span>
<span></span>
<span><span class="co">#we must first turn into dummy variables:</span></span>
<span><span class="va">new_df_indicatorvars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dummy_vars.html">dummy_vars</a></span><span class="op">(</span><span class="va">new_df</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">new_df_indicatorvars</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Smoking_Status Sex_F Sex_M</span></span>
<span><span class="co">#&gt; 1              1     0     1</span></span>
<span><span class="co">#&gt; 2              0     1     0</span></span>
<span><span class="co">#&gt; 3              0     0     1</span></span>
<span><span class="co">#&gt; 4              1     0     1</span></span>
<span><span class="co">#&gt; 5              1     1     0</span></span>
<span><span class="co">#&gt; 6              0     1     0</span></span>
<span></span>
<span><span class="co">#and then pass to functions within predRupdate; e.g.:</span></span>
<span><span class="fu"><a href="../reference/pred_predict.html">pred_predict</a></span><span class="op">(</span><span class="va">existing_Logistic_Model</span>, </span>
<span>             new_data <span class="op">=</span> <span class="va">new_df_indicatorvars</span><span class="op">)</span></span>
<span><span class="co">#&gt; $LinearPredictor</span></span>
<span><span class="co">#&gt; [1] -2.466 -3.400 -3.094 -2.466 -2.772 -3.400 -2.466</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $PredictedRisk</span></span>
<span><span class="co">#&gt; [1] 0.07827635 0.03229546 0.04335543 0.07827635 0.05885613 0.03229546 0.07827635</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $Outcomes</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Glen P. Martin, David Jenkins, Matthew Sperrin.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
